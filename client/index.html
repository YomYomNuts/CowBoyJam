<!DOCTYPE html>
<html>
	<head>
		<title>CowBoyJam</title>
		<meta charset="UTF-8">
		<script src="socket.io-1.3.5.js"></script>
		<script src="jquery-2.1.4.min.js"></script>
		<script src="pixi.js"></script>
	</head>
	<body>
		<input id="idRoom" type="hidden" value=""/>
		<input id="idUser" type="hidden" value=""/>
		<script>
			// launch the socket
			var socket = io();

			// create an new instance of a pixi stage
		    var stage = new PIXI.Stage(0xFFFF99);
		    var renderer = PIXI.autoDetectRenderer($(document.body).width(), $(document.body).height());
		    renderer.view.id = "renderer";
		    var gameContainer = new PIXI.DisplayObjectContainer();
			stage.addChild(gameContainer);
		    document.body.appendChild(renderer.view);

		    // importing a texture atlas created with texturepacker
			var maxUsers = 10;
			var tileAtlas = ["images.json"];
			var loader = new PIXI.AssetLoader(tileAtlas);
			var assetsReadyFlag = false;
			loader.onComplete = function() {
		    	assetsReadyFlag = true;
			};
			loader.load();

			//update renderer
			requestAnimFrame(animate);
		    function animate() {
		        requestAnimFrame(animate);
		        renderer.render(stage);
		    }

			function addUser(idUser, nbUsers) {
				if (!assetsReadyFlag)
					return;
		    	// create a texture from an image path
			    var user = PIXI.Sprite.fromFrame(maxUsers + idUser);
			    user.interactive = true;
			    user.tint = 0xffffff;
			    user.alpha = 1;
			    user.scale = new PIXI.Point(0.5, 0.5);
			    var widthByUser = $(document.body).width() / nbUsers;
			    user.position.x = widthByUser * idUser;
			    user.position.y = $(document.body).height() * 0.5;
			    gameContainer.addChild(user);
		    }

		    function addUsers(nbUsers) {
	    		stage.removeChild(gameContainer);
	    		gameContainer = new PIXI.DisplayObjectContainer();
 				stage.addChild(gameContainer);
		    	for (var i = 0; i < nbUsers; ++i) {
		    		addUser(i, nbUsers);
		    	}
		    }

		    function registerUser() {
		    	socket.emit('addUser');
		    }
		</script>
		<script>
			$('#renderer').on("mousedown", function(event) {
				socket.emit('keyDown', event.which);
			});
			socket.on('idRoom', function(idRoom) {
				$('#idRoom').val(idRoom);
			});
			socket.on('idUser', function(idUser) {
				$('#idUser').val(idUser);
			});
			socket.on('nbUsers', function(info) {
				setTimeout(addUsers(info.userInfos), 100);
			});
		</script>
	</body>
</html>