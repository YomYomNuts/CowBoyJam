<!DOCTYPE html>
<html>
	<head>
		<title>CowBoyJam</title>
		<meta charset="UTF-8">
		<script src="socket.io-1.3.5.js"></script>
		<script src="jquery-2.1.4.min.js"></script>
		<script src="pixi.min.js"></script>
		<link href="style.css" rel="stylesheet" media="all" type="text/css"> 
	</head>
	<body>
		<input id="idRoom" type="hidden" value=""/>
		<input id="idUser" type="hidden" value=""/>
		<input id="nbUsers" type="hidden" value=""/>
		<script>
			// launch the socket
			var socket = io();
			var users = [null, null, null, null, null, null, null, null, null, null];
			var sherif = null;
			var currentStateSherif = 0;
			var head = null;
			var currentIdHead = 0;

			// create an new instance of a pixi stage
		    var stage = new PIXI.Container();
		    var renderer = PIXI.autoDetectRenderer(window.innerWidth, window.innerHeight, { backgroundColor : 0xFFFF99 } );
		    renderer.view.id = "renderer";
		    var gameContainer = new PIXI.Container();
			stage.addChild(gameContainer);
		    document.body.appendChild(renderer.view);
			var light1 = PIXI.Sprite.fromImage('LightRotate1.png');
			var cactus1 = PIXI.Sprite.fromImage('Cactus1.png');
		    cactus1.position.x = $(document.body).width() / 4;
		    cactus1.position.y = $(document.body).height() * 3 / 4;
			var cactus2 = PIXI.Sprite.fromImage('Cactus2.png');
		    cactus2.position.x = $(document.body).width() * 3 / 4;
		    cactus2.position.y = $(document.body).height() * 3 / 4;
			var cactus3 = PIXI.Sprite.fromImage('Cactus2.png');
		    cactus3.position.x = $(document.body).width() * 2.5 / 4;
		    cactus3.position.y = $(document.body).height() * 0.1 / 4;

		    // importing a texture atlas created with texturepacker
			var maxUsers = 10;
			var maxState = 9;
			var assetsReadyFlag = false;
			PIXI.loader
				.add("images.json")
				.once('complete', function() {
			    	assetsReadyFlag = true;
			    	console.log('load complete');
					socket.emit('addUser');
				})
				.load();

			// Text
	    	var infos = new PIXI.Text("F5 : New Game\nRigth Arrow : Right Shoot\nLeft Arrow : Left Shoot\nDown Arrow : Dodge Shoot", {font: "bold 30px Podkova", fill: "#cc00ff", align: "center", stroke: "#FFFFFF", strokeThickness: 6});
		    infos.position.x = 10;
		    infos.position.y = 10;
	    	var timerText = new PIXI.Text("0", {font: "bold 60px Podkova", fill: "#cc00ff", align: "center", stroke: "#FFFFFF", strokeThickness: 6});
	    	timerText.anchor.set(0.5);
		    timerText.position.x = $(document.body).width() / 2;
		    timerText.position.y = $(document.body).height() / 4;
	    	var timerWaitingPlayersText = new PIXI.Text("Waiting Players 10s", {font: "bold 40px Podkova", fill: "#cc00ff", align: "center", stroke: "#FFFFFF", strokeThickness: 6}); // maxTimeWaiting dans main.js
	    	timerWaitingPlayersText.anchor.set(0.5);
		    timerWaitingPlayersText.position.x = $(document.body).width() / 2;
		    timerWaitingPlayersText.position.y = $(document.body).height() / 8;
		    timerWaitingPlayersText.isDisplaying = false;

			//update renderer
			animate();
			function animate() {
			    renderer.render(stage);
			    requestAnimationFrame(animate);
				// force resize
				if(window.innerWidth !== w || window.innerHeight !== h)
					resize();
			}

			window.requestAnimFrame = (function(callback) {
				return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
				function(callback) {
					window.setTimeout(callback, 1000 / 60);
				};
			})();

			var w = window.innerWidth;
			var h = window.innerHeight;
			function resize() {
				w = window.innerWidth;
				h = window.innerHeight;
				renderer.resize(w, h);
				stage.filterArea = new PIXI.math.Rectangle(0, 0, w, h);
				var scale = Math.min(w/DEFAULT_W, h/DEFAULT_H);
				stage.scale.x = stage.scale.y = scale;
				stage.position.x = w/2;
				stage.position.y = h/2;
			}
			resize();
			window.onresize = function(e) {
				resize();
			}

		    // state : [0=head], [1=stay], [2=dead], [3=missSquat], [4=squat], [5=deadRight], [6=fireRight], [7=deadLeft], [8=fireLeft]
			function setUser(idUser, nbUsers, state) {
				if (users[idUser] != null) {
					gameContainer.removeChild(users[idUser]);
				}
					
		    	// create a texture from an image path
			    var user = PIXI.Sprite.fromFrame(state + '_' + idUser + '.png');
			    user.interactive = true;
			    user.tint = 0xffffff;
			    user.alpha = 1;
			    user.scale = new PIXI.Point(0.5, 0.5);
			    var widthByUser = w / (nbUsers + 1);
			    user.position.x = widthByUser * idUser;
			    user.position.y = h * 0.5;
			    users[idUser] = user;
			    gameContainer.addChild(user);
		    }

		    // state : [0=stay], [1=wanted], [2=fire]
		    function setSherif(state) {
				if (sherif != null) {
					gameContainer.removeChild(sherif);
				}

		    	// create a texture from an image path
		    	currentStateSherif = state;
			    var user = PIXI.Sprite.fromFrame('sherif' + state + '.png');
			    user.interactive = true;
			    user.tint = 0xffffff;
			    user.alpha = 1;
			    user.scale = new PIXI.Point(0.5, 0.5);
			    user.position.x = w * 0.8;
			    user.position.y = h * 0.1;
			    sherif = user;
			    gameContainer.addChild(user);
		    }

		    function addHead(idUser) {
				if (head != null) {
					gameContainer.removeChild(head);
				}

		    	// create a texture from an image path
		    	currentIdHead = idUser;
			    var user = PIXI.Sprite.fromFrame('head' + idUser + '.png');
			    user.interactive = true;
			    user.tint = 0xffffff;
			    user.alpha = 1;
			    user.scale = new PIXI.Point(0.5, 0.5);
			    user.position.x = w * 0.8;
			    user.position.y = h * 0.1;
			    head = user;
			    gameContainer.addChild(user);
		    }

		    function addUsers(nbUsers) {
	    		stage.removeChild(gameContainer);
	    		gameContainer = new PIXI.Container();
 				stage.addChild(gameContainer);cactus1
		    	gameContainer.addChild(infos);
		    	gameContainer.addChild(cactus1);
		    	gameContainer.addChild(cactus2);
		    	gameContainer.addChild(cactus3);
 				users = [null, null, null, null, null, null, null, null, null, null];
		    	for (var i = 0; i < nbUsers; ++i) {
		    		setUser(i, nbUsers, 1);
		    	}
		    }

		    function partyIsRunning(active) {
		    	if (active) {
					gameContainer.addChild(timerText);
				} else {
					gameContainer.removeChild(timerText);
				}
		    }

		    function timerInfos(time) {
		    	var valueTime = parseInt(time);
		    	if (valueTime > 0) {
		    		timerText.text = valueTime;
		    	} else {
		    		timerText.text = "Let's Go!";
		    	}
		    }

		    function timerWaitingPlayersInfos(time) {
		    	var valueTime = parseInt(time);
		    	if (valueTime > 0) {
		    		timerWaitingPlayersText.text = 'Waiting Players ' + valueTime + 's';
		    		if (!timerWaitingPlayersText.isDisplaying) {
						gameContainer.addChild(timerWaitingPlayersText);
					}
		    	} else {
					gameContainer.removeChild(timerWaitingPlayersText);
		    	}
		    }

		    function registerUser() {
		    	socket.emit('addUser');
		    }

		    function winner(idUser, nbUsers) {
			    var widthByUser = $(document.body).width() / (nbUsers + 1);
			    light1.position.x = widthByUser * idUser - 387 / 4;
			    light1.position.y = h * 0.5 - 388 / 4;
				gameContainer.addChild(light1);
				setUser(idUser, nbUsers, 1);
		    }
		</script>
		<script>
			$('#renderer').on("mousedown", function(event) {
				socket.emit('keyDown', event.which);
			});
			$('#renderer').on("mouseup", function(event) {
				socket.emit('keyUp', event.which);
			});
			$(window).keydown(function(event) {
				if (event.keyCode == 37) { // Left
					socket.emit('keyDown', 1);
				} else if (event.keyCode == 39) { // Right
					socket.emit('keyDown', 3);
				} else if (event.keyCode == 40) { // Down
					socket.emit('keyDown', 2);
				}
			});
			$(window).keyup(function(event) {
				if (event.keyCode == 37) { // Left
					socket.emit('keyUp', 1);
				} else if (event.keyCode == 39) { // Right
					socket.emit('keyUp', 3);
				} else if (event.keyCode == 40) { // Down
					socket.emit('keyUp', 2);
				}
			});
			socket.on('ping', function(info) {
				socket.emit('pong');
			});
			socket.on('idRoom', function(idRoom) {
				$('#idRoom').val(idRoom);
			});
			socket.on('idUser', function(idUser) {
				$('#idUser').val(idUser);
			});
			socket.on('nbUsers', function(info) {
				$('#nbUsers').val(info.userInfos);
				addUsers(info.userInfos);
				setSherif(0);
			});
			socket.on('stay', function(info) {
				setUser(info.userInfos, parseInt($('#nbUsers').val()), 1);
			});
			socket.on('delayStay', function(info) {
				window.setTimeout(function() {
					setUser(info.userInfos, parseInt($('#nbUsers').val()), 1)
				}, 300);
			});
			socket.on('dead', function(info) {
				setUser(info.userInfos, parseInt($('#nbUsers').val()), 2);
			});
			socket.on('missSquat', function(info) {
				setUser(info.userInfos, parseInt($('#nbUsers').val()), 3);
			});
			socket.on('squat', function(info) {
				setUser(info.userInfos, parseInt($('#nbUsers').val()), 4);
			});
			socket.on('deadRight', function(info) {
				setUser(info.userInfos, parseInt($('#nbUsers').val()), 5);
				if (head != null) {
					gameContainer.removeChild(head);
					head = null;
				}
				setSherif(2);
				window.setTimeout(function() {
					setUser(info.userInfos, parseInt($('#nbUsers').val()), 2)
				}, 300);
			});
			socket.on('fireRight', function(info) {
				setUser(info.userInfos, parseInt($('#nbUsers').val()), 6);
			});
			socket.on('deadLeft', function(info) {
				setUser(info.userInfos, parseInt($('#nbUsers').val()), 7);
				if (head != null) {
					gameContainer.removeChild(head);
					head = null;
				}
				setSherif(2);
				window.setTimeout(function() {
					setUser(info.userInfos, parseInt($('#nbUsers').val()), 2)
				}, 300);
			});
			socket.on('fireLeft', function(info) {
				setUser(info.userInfos, parseInt($('#nbUsers').val()), 8);
			});
			socket.on('start', function(info) {
				partyIsRunning(info.userInfos);
			});
			socket.on('timer', function(info) {
				timerInfos(info.userInfos);
			});
			socket.on('timerWaitingPlayers', function(info) {
				timerWaitingPlayersInfos(info.userInfos);
			});
			socket.on('wanted', function(info) {
				if (currentStateSherif == 2) {
					window.setTimeout(function() {
						setSherif(1);
						addHead(info.userInfos);
					}, 500);
				} else {
					setSherif(1);
					addHead(info.userInfos);
				}
			});
			socket.on('winner', function(info) {
				winner(info.userInfos, parseInt($('#nbUsers').val()));
			});
		</script>
	</body>
</html>